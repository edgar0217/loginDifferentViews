<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Eventos Alumnos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/styles.css" />
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="min-h-screen bg-gray-100 p-6">
  <% if (!usuario || usuario.rol !== 'alumno') { %>
  <script>
    window.location.href = "/login";
  </script>
  <% } %>

  <main class="max-w-3xl mx-auto bg-gray-900 rounded-xl shadow-lg p-8 text-gray-300">
    <!-- Header -->
    <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
      <p class="font-semibold text-xl text-teal-400">
        Bienvenid@, Usuario <%= usuario ? usuario.nombre.toUpperCase() + " " + usuario.apellidos.toUpperCase() : "Invitado" %>
      </p>
      <form action="/logout" method="GET" class="w-full md:w-auto">
        <button
          type="submit"
          class="w-full md:w-auto bg-red-700 hover:bg-red-800 text-white font-semibold px-6 py-2 rounded-lg transition"
        >
          Cerrar sesión
        </button>
      </form>
    </div>

    <h1 class="text-4xl font-extrabold mb-10 text-teal-400 text-center">Crear Nuevo Reporte</h1>

    <img
      src="/img/decoracion3.jpg"
      alt="Decoración"
      class="w-full max-w-xl mx-auto mb-10 rounded-lg object-contain shadow-lg"
    />

    <% if (error) { %>
    <p
      class="mb-6 p-4 bg-red-900 bg-opacity-60 text-red-400 rounded-lg border border-red-700 text-center font-semibold"
    >
      <%= error %>
    </p>
    <% } %>

    <form
      id="formCrearEvento"
      action="/eventos/nuevo"
      method="POST"
      enctype="multipart/form-data"
      class="space-y-8 mb-14"
    >
      <div>
        <label for="titulo" class="block mb-3 font-semibold text-teal-300 text-lg">Título</label>
        <input
          type="text"
          id="titulo"
          name="titulo"
          placeholder="Ingresa Casilla, Campaña o Votacion"
          required
          class="w-full p-4 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-4 focus:ring-teal-400 transition"
        />
      </div>

      <div>
        <label for="descripcion" class="block mb-3 font-semibold text-teal-300 text-lg">Descripción</label>
        <select
          id="descripcion"
          name="descripcion"
          required
          class="w-full p-4 border border-gray-700 rounded-lg bg-gray-800 text-gray-200 focus:outline-none focus:ring-4 focus:ring-teal-400 transition"
        >
          <option value="" disabled selected>Selecciona una opción</option>
          <option value="Adaneli - Poza Rica">Adaneli - Poza Rica</option>
          <option value="Alanís - Coatzintla">Alanís - Coatzintla</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div>
        <label class="block mb-3 font-semibold text-teal-300 text-lg">Imagen del evento</label>
        <div class="flex gap-4 flex-wrap">
          <button
            type="button"
            id="btnSeleccionarArchivo"
            class="bg-teal-700 hover:bg-teal-800 text-white px-6 py-2 rounded-lg shadow-md transition"
          >
            Seleccionar foto
          </button>
          <button
            type="button"
            id="btnTomarFoto"
            class="bg-teal-700 hover:bg-teal-800 text-white px-6 py-2 rounded-lg shadow-md transition"
          >
            Tomar foto
          </button>
        </div>
        <input
          type="file"
          id="inputArchivo"
          name="imagen"
          accept="image/*"
          class="hidden"
          onchange="previewImage(event)"
        />
        <input
          type="file"
          id="inputCamara"
          name="imagen"
          accept="image/*"
          capture="environment"
          class="hidden"
          onchange="previewImage(event)"
        />
        <div id="previewContainer" class="mt-6"></div>
      </div>

      <div class="flex flex-col sm:flex-row gap-6">
        <button
          type="submit"
          class="flex-1 py-4 bg-teal-700 hover:bg-teal-800 text-white rounded-lg font-semibold transition shadow-lg"
        >
          Crear Evento
        </button>
        <button
          type="button"
          id="btnLimpiar"
          class="flex-1 py-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition shadow-lg"
        >
          Limpiar formulario
        </button>
      </div>
    </form>

    <h2 class="text-4xl font-extrabold mb-8 text-teal-400 text-center">Eventos</h2>

    <div class="overflow-x-auto max-w-full pb-6">
      <% if (eventos.length === 0) { %>
      <p class="text-center text-gray-500 text-lg">No hay eventos registrados.</p>
      <% } else { %>
      <div class="flex flex-col space-y-6">
        <% eventos.forEach(evento => { %>
        <article
          class="evento-card p-6 border border-teal-500 rounded-xl shadow-lg bg-gradient-to-r from-gray-800 via-gray-900 to-black flex flex-col sm:flex-row items-start sm:items-center gap-6 hover:scale-[1.02] transition-transform duration-300"
        >
          <div class="flex-shrink-0 w-full sm:w-48 h-32 rounded-lg overflow-hidden border border-teal-600 shadow-inner">
            <% if (evento.url_imagen) { %>
            <img
              src="<%= evento.url_imagen %>"
              alt="Imagen evento"
              class="w-full h-full object-cover"
            />
            <% } else { %>
            <div class="w-full h-full bg-gray-700 flex items-center justify-center text-gray-400 italic select-none">
              Sin imagen
            </div>
            <% } %>
          </div>
          <div class="flex-1 flex flex-col">
            <h3 class="text-2xl font-bold text-teal-300"><%= evento.titulo %></h3>
            <p class="mt-2 text-gray-400 leading-relaxed"><%= evento.descripcion %></p>
          </div>
        </article>
        <% }) %>
      </div>

      <!-- Paginación inteligente -->
      <% if (totalPages > 1) { %>
      <nav
        class="flex justify-center items-center space-x-3 mt-12 flex-shrink-0 select-none"
        role="navigation"
        aria-label="Paginación de eventos"
      >
        <% if (currentPage > 1) { %>
        <a
          href="/eventos?page=1"
          class="px-4 py-2 bg-teal-600 text-white rounded-lg shadow hover:bg-teal-700"
          aria-label="Primera página"
          >« Inicio</a
        >
        <a
          href="/eventos?page=<%= currentPage - 1 %>"
          class="px-4 py-2 bg-teal-600 text-white rounded-lg shadow hover:bg-teal-700"
          aria-label="Página anterior"
          >‹ Anterior</a
        >
        <% } else { %>
        <span
          class="px-4 py-2 bg-gray-600 text-gray-400 rounded-lg cursor-not-allowed select-none"
          aria-disabled="true"
          >« Inicio</span
        >
        <span
          class="px-4 py-2 bg-gray-600 text-gray-400 rounded-lg cursor-not-allowed select-none"
          aria-disabled="true"
          >‹ Anterior</span
        >
        <% } %>

        <% 
          const visiblePages = 11;
          const half = Math.floor(visiblePages / 2);
          let startPage = currentPage - half;
          let endPage = currentPage + half;
          if (startPage < 1) {
            endPage += 1 - startPage;
            startPage = 1;
          }
          if (endPage > totalPages) {
            startPage -= (endPage - totalPages);
            endPage = totalPages;
          }
          if (startPage < 1) startPage = 1;
        %>

        <% for(let i = startPage; i <= endPage; i++) { %>
        <% if (i === currentPage) { %>
        <span
          class="px-4 py-2 bg-teal-800 text-white rounded-lg font-semibold shadow select-none"
          aria-current="page"
          > <%= i %> </span
        >
        <% } else { %>
        <a
          href="/eventos?page=<%= i %>"
          class="px-4 py-2 bg-teal-600 text-white rounded-lg shadow hover:bg-teal-700 transition"
          aria-label="Ir a página <%= i %>"
          ><%= i %></a
        >
        <% } %>
        <% } %>

        <% if (currentPage < totalPages) { %>
        <a
          href="/eventos?page=<%= currentPage + 1 %>"
          class="px-4 py-2 bg-teal-600 text-white rounded-lg shadow hover:bg-teal-700 transition"
          aria-label="Página siguiente"
          >Siguiente ›</a
        >
        <a
          href="/eventos?page=<%= totalPages %>"
          class="px-4 py-2 bg-teal-600 text-white rounded-lg shadow hover:bg-teal-700 transition"
          aria-label="Última página"
          >Fin »</a
        >
        <% } else { %>
        <span
          class="px-4 py-2 bg-gray-600 text-gray-400 rounded-lg cursor-not-allowed select-none"
          aria-disabled="true"
          >Siguiente ›</span
        >
        <span
          class="px-4 py-2 bg-gray-600 text-gray-400 rounded-lg cursor-not-allowed select-none"
          aria-disabled="true"
          >Fin »</span
        >
        <% } %>
      </nav>
      <% } %>
      <% } %>
    </div>
  </main>

  <script src="/js/even
